---
name: stratisd CI

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - master
      - develop-2.4.2
    paths-ignore:
      - 'CHANGES.txt'
      - '**/README.md'
  pull_request:
    branches:
      - master
      - develop-2.4.2
    paths-ignore:
      - 'CHANGES.txt'
      - '**/README.md'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # RPM building tasks, for testing
  packaging:
    runs-on: ubuntu-18.04
    container:
      image: fedora:34  # LOWEST SUPPORTED RELEASE
    steps:
      - uses: actions-rs/toolchain@v1
        with:
          components: cargo
          toolchain: 1.54.0  # CURRENT DEVELOPMENT RUST TOOLCHAIN
      - name: Install dependencies
        run: >
          dnf install -y
          fedpkg
          findutils
          git
          make
          rpm
          rpmdevtools
          tar
          util-linux
      - name: Check out Fedora repo
        run: fedpkg clone --anonymous stratisd ../stratisd-spec
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set release version
        run: >
          echo
          "RELEASE_VERSION=$(git describe --abbrev=0 | colrm 1 1)"
          >>
          $GITHUB_ENV
      - name: Create directories
        run: mkdir -p ~/rpmbuild/{RPMS,SOURCES}
      - name: Make the source tar file
        run: >
          tar czvf ~/rpmbuild/SOURCES/stratisd-${{ env.RELEASE_VERSION }}.tar.gz
          --exclude-vcs
          --exclude-vcs-ignore
          stratisd
        working-directory: ..
      - name: Make the vendor tar file
        run: >
          RELEASE_VERSION=${{ env.RELEASE_VERSION }}
          VENDOR_OUTPUT_DIR=~/rpmbuild/SOURCES
          make -f Makefile vendored-tar-file
      - name: Bump the release version in the spec
        run: rpmdev-bumpspec stratisd.spec
        working-directory: ../stratisd-spec
      - name: Compile the package
        run: rpmbuild -bc stratisd.spec
        working-directory: ../stratisd-spec
