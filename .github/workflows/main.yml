---
name: stratisd CI

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - master
      - develop-2.4.2
    paths-ignore:
      - 'CHANGES.txt'
      - '**/README.md'
  pull_request:
    branches:
      - master
      - develop-2.4.2
    paths-ignore:
      - 'CHANGES.txt'
      - '**/README.md'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # RPM building tasks, for testing
  packaging:
    runs-on: ubuntu-18.04
    container:
      image: fedora:34  # LOWEST SUPPORTED RELEASE
    steps:
      - name: Install dependencies
        run: >
          dnf install -y
          asciidoc
          cargo
          cryptsetup-devel
          dracut
          fedpkg
          findutils
          git
          libblkid-devel
          make
          rpm
          rpmdevtools
          rust
          rust-bindgen-devel
          rust-byteorder-devel
          rust-chrono-devel
          rust-clap-devel
          rust-crc-devel
          rust-data-encoding-devel
          rust-dbus-tree-devel
          rust-devicemapper-devel
          rust-either-devel
          rust-env_logger-devel
          rust-futures-devel
          rust-itertools-devel
          rust-lazy_static-devel
          rust-libc-devel
          rust-libcryptsetup-rs-devel
          rust-libmount-devel
          rust-libudev-devel
          rust-log-devel
          rust-nix-devel
          rust-packaging
          rust-pkg-config-devel
          rust-rand-devel
          rust-regex-devel
          rust-serde-devel
          rust-serde_derive-devel
          rust-serde_json-devel
          rust-sha2-devel
          rust-tempfile-devel
          rust-tokio-devel
          rust-tokio-macros-devel
          rust-uuid-devel
          tar
          util-linux
      - name: Check out Fedora repo
        run: fedpkg clone --anonymous stratisd ../stratisd-spec
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set release version
        run: >
          echo
          "RELEASE_VERSION=$(git describe --abbrev=0 | colrm 1 1)"
          >>
          $GITHUB_ENV
      - name: Create directories
        run: mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES}
      - name: Rename stratisd directory
        run: cp -r stratisd stratisd-${{ env.RELEASE_VERSION }}
        working-directory: ..
      - name: Make the source tar file
        run: >
          tar czvf ~/rpmbuild/SOURCES/stratisd-${{ env.RELEASE_VERSION }}.tar.gz
          --exclude-vcs
          --exclude-vcs-ignore
          stratisd-${{ env.RELEASE_VERSION }}
        working-directory: ..
      - name: Make the vendor tar file
        run: >
          RELEASE_VERSION=${{ env.RELEASE_VERSION }}
          VENDOR_OUTPUT_DIR=~/rpmbuild/SOURCES
          make -f Makefile vendored-tar-file
        working-directory: ../stratisd-${{ env.RELEASE_VERSION }}
      - name: Bump the release version in the spec
        run: rpmdev-bumpspec stratisd.spec
        working-directory: ../stratisd-spec
      - name: Compile the package
        run: rpmbuild -bc stratisd.spec
        working-directory: ../stratisd-spec
