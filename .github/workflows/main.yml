---
name: stratisd CI

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - master
      - develop-2.4.2
    paths-ignore:
      - 'CHANGES.txt'
      - '**/README.md'
  pull_request:
    branches:
      - master
      - develop-2.4.2
    paths-ignore:
      - 'CHANGES.txt'
      - '**/README.md'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # RPM building tasks, for testing
  packaging:
    runs-on: ubuntu-18.04
    container:
      image: fedora:34  # LOWEST SUPPORTED RELEASE
    steps:
      - name: Install dependencies
        run: >
          dnf install -y
          asciidoc
          cargo
          cryptsetup-devel
          dracut
          fedpkg
          findutils
          git
          libblkid-devel
          make
          rpm
          rpmdevtools
          rust-packaging
          rust-srpm-macros
          tar
          util-linux
      - name: Check out Fedora repo
        run: fedpkg clone --anonymous stratisd ../stratisd-spec
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set release version
        run: >
          echo
          "RELEASE_VERSION=$(git describe --abbrev=0 | colrm 1 1)"
          >>
          $GITHUB_ENV
      - name: Create directories
        run: mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SRPMS}
      - name: Rename stratisd directory
        run: cp -r stratisd stratisd-${{ env.RELEASE_VERSION }}
        working-directory: ..
      - name: Make the source tar file
        run: >
          tar czvf ~/rpmbuild/SOURCES/stratisd-${{ env.RELEASE_VERSION }}.tar.gz
          --exclude-vcs
          --exclude-vcs-ignore
          stratisd-${{ env.RELEASE_VERSION }}
        working-directory: ..
      - name: Make the vendor tar file
        run: >
          RELEASE_VERSION=${{ env.RELEASE_VERSION }}
          VENDOR_OUTPUT_DIR=~/rpmbuild/SOURCES
          make -f Makefile vendored-tar-file
        working-directory: ../stratisd-${{ env.RELEASE_VERSION }}
      - name: Bump the release version in the spec
        run: rpmdev-bumpspec stratisd.spec
        working-directory: ../stratisd-spec
      - name: Build the source package
        # yamllint disable rule:line-length
        run: |
          rpmbuild -bs --nodeps stratisd-spec/stratisd.spec
          dnf builddep ~/rpmbuild/SRPMS/stratisd-${{ env.RELEASE_VERSION }}*src.rpm
        working-directory: ..
      - name: Build the source package with dynamic build dependencies
        # yamllint disable rule:line-length
        run: |
          rpmbuild -br --nodeps stratisd-spec/stratisd.spec
          dnf builddep ~/rpmbuild/SRPMS/stratisd-${{ env.RELEASE_VERSION }}*buildreqs.nosrc.rpm
        working-directory: ..
